# 🎉 سیستم اعلان‌ها، آمار بازدید و تمدید آگهی - دیپلوی شد!

## ✅ وضعیت سرورها
- ✅ Backend: http://localhost:8080
- ✅ Frontend: http://localhost:5173
- ✅ Database: SQLite (bilflow.db)
- ✅ Migration: اجرا شد

## 🆕 امکانات جدید

### 1️⃣ سیستم اعلان‌های Real-time
**برای کاربران:**
- 🔔 زنگ اعلان در هدر سایت (نمایش تعداد خوانده نشده)
- 📱 صفحه کامل اعلان‌ها: `/dashboard/notifications`
- ✅ اعلان تایید/رد آگهی
- ⏰ اعلان نزدیک شدن به انقضا (7 روز قبل)
- 🚫 اعلان انقضای آگهی
- 💰 اعلان تایید پرداخت
- 🔄 اعلان تایید/رد تمدید

**API Endpoints:**
```
GET    /api/notifications              - لیست اعلان‌ها
GET    /api/notifications/unread-count - تعداد خوانده نشده
PUT    /api/notifications/:id/read     - خواندن یک اعلان
PUT    /api/notifications/read-all     - خواندن همه
DELETE /api/notifications/:id          - حذف اعلان
```

### 2️⃣ آمار بازدید آگهی‌ها
**امکانات:**
- 📊 نمودار بازدید روزانه (7/14/30 روز)
- 👁️ ثبت خودکار بازدید
- 📞 آمار کلیک روی تماس
- ❤️ آمار افزودن به علاقه‌مندی
- 📈 خلاصه آمار کل

**API Endpoints:**
```
POST /api/listing-stats/:id/view           - ثبت بازدید
POST /api/listing-stats/:id/contact-click  - ثبت کلیک تماس
POST /api/listing-stats/:id/favorite       - ثبت علاقه‌مندی
GET  /api/listing-stats/:id/daily          - آمار روزانه
GET  /api/listing-stats/:id/weekly         - آمار هفتگی
GET  /api/listing-stats/:id/summary        - خلاصه آمار
GET  /api/listing-stats/my-listings        - آمار همه آگهی‌های کاربر
GET  /api/listing-stats/top                - پرطرفدارترین آگهی‌ها
```

### 3️⃣ سیستم تمدید آگهی
**تنظیمات پیش‌فرض:**
- ⏱️ مدت اعتبار آگهی: **90 روز**
- 🆓 تمدید رایگان: **1 بار** برای هر آگهی
- 💵 هزینه تمدید: **50,000 تومان** (قابل تنظیم)
- 📅 مدت تمدید: **30 روز**
- 🔔 یادآوری: **7 روز** قبل از انقضا

**برای کاربران:**
- صفحه تمدید: `/dashboard/renew/:id`
- لیست آگهی‌های در حال انقضا در داشبورد
- تمدید رایگان خودکار (بدون نیاز به تایید ادمین)
- تمدید پولی (نیاز به تایید ادمین)

**برای ادمین:**
- تب "تمدید آگهی‌ها" در پنل مدیریت
- تایید/رد درخواست‌های تمدید پولی
- تنظیمات قیمت و مدت
- ارسال یادآوری دستی
- منقضی کردن دستی آگهی‌ها
- آمار کامل تمدیدها

**API Endpoints:**
```
# کاربران
GET  /api/renewals/settings           - تنظیمات تمدید
GET  /api/renewals/check/:id          - بررسی وضعیت تمدید
POST /api/renewals/request            - درخواست تمدید
GET  /api/renewals/history/:id        - تاریخچه تمدید
GET  /api/renewals/expiring           - آگهی‌های در حال انقضا

# ادمین
GET  /api/admin/renewals/pending      - درخواست‌های در انتظار
GET  /api/admin/renewals/all          - همه درخواست‌ها
POST /api/admin/renewals/:id/approve  - تایید
POST /api/admin/renewals/:id/reject   - رد
GET  /api/admin/renewals/settings     - دریافت تنظیمات
PUT  /api/admin/renewals/settings     - به‌روزرسانی تنظیمات
GET  /api/admin/renewals/stats        - آمار تمدیدها
POST /api/admin/renewals/expire-old   - منقضی کردن دستی
POST /api/admin/renewals/send-reminders - ارسال یادآوری
```

## 🗄️ جداول دیتابیس

### user_notifications
```sql
- id, user_id, type, title, message
- data (JSON), is_read, read_at
- created_at
```

### renewal_settings
```sql
- id, setting_key, setting_value
- description, updated_at
```

### listing_renewals
```sql
- id, listing_id, user_id
- renewal_type (free/paid)
- amount, payment_status, payment_method
- old_expiry_date, new_expiry_date
- status (pending/approved/rejected)
- admin_note, processed_by, processed_at
```

### listing_daily_stats
```sql
- id, listing_id, stat_date
- view_count, unique_views
- favorite_count, contact_clicks
```

### فیلدهای جدید در listings
```sql
- expires_at (تاریخ انقضا)
- renewal_count (تعداد تمدید)
```

## ⏰ Cron Jobs خودکار

**هر روز ساعت 8 صبح:**
1. منقضی کردن آگهی‌های قدیمی
2. ارسال یادآوری انقضا (7 روز قبل)
3. پاکسازی اعلان‌های قدیمی (بیش از 30 روز)

## 🎨 کامپوننت‌های جدید

### Frontend
- `NotificationBell` - زنگ اعلان در هدر
- `ListingStatsChart` - نمودار آمار بازدید
- `RenewalRequest` - فرم درخواست تمدید
- `ExpiringListings` - لیست آگهی‌های در حال انقضا
- `AdminRenewals` - پنل مدیریت تمدید

### Backend
- `notificationService` - مدیریت اعلان‌ها
- `listingStatsService` - مدیریت آمار
- `renewalService` - مدیریت تمدید

## 📝 نحوه استفاده

### برای کاربران:

1. **مشاهده اعلان‌ها:**
   - کلیک روی زنگ در هدر سایت
   - یا مراجعه به `/dashboard/notifications`

2. **تمدید آگهی:**
   - از داشبورد، روی "تمدید" کلیک کنید
   - یا مستقیم به `/dashboard/renew/:id` بروید
   - اولین تمدید رایگان است
   - تمدیدهای بعدی 50,000 تومان

3. **مشاهده آمار:**
   - در صفحه تمدید، نمودار آمار نمایش داده می‌شود
   - آمار بازدید، کلیک تماس و علاقه‌مندی

### برای ادمین:

1. **مدیریت تمدیدها:**
   - پنل ادمین → تب "تمدید آگهی‌ها"
   - تایید/رد درخواست‌های پولی
   - مشاهده آمار کامل

2. **تنظیمات:**
   - تغییر قیمت تمدید
   - تغییر مدت اعتبار
   - تغییر تعداد تمدید رایگان
   - تنظیم زمان یادآوری

3. **عملیات دستی:**
   - ارسال یادآوری به همه
   - منقضی کردن آگهی‌های قدیمی

## 🔍 تست سیستم

### 1. تست اعلان‌ها:
```bash
# لاگین کنید و یک آگهی ثبت کنید
# ادمین آگهی را تایید کند
# اعلان تایید را در زنگ ببینید
```

### 2. تست آمار:
```bash
# یک آگهی را چند بار مشاهده کنید
# به صفحه تمدید بروید
# نمودار آمار را ببینید
```

### 3. تست تمدید:
```bash
# یک آگهی قدیمی انتخاب کنید
# درخواست تمدید دهید
# اولین بار رایگان است
# بار دوم باید پرداخت کنید
```

## 🚀 دستورات مفید

```bash
# اجرای migration
cd server
node database/run-notifications-renewal-migration.js

# شروع سرورها
npm run dev          # Frontend
cd server && node server.js  # Backend

# یا استفاده از فایل bat
restart-servers.bat
```

## 📊 آمار سیستم

- ✅ 4 جدول جدید
- ✅ 2 فیلد جدید در listings
- ✅ 15 API endpoint جدید
- ✅ 5 کامپوننت React جدید
- ✅ 3 سرویس Backend جدید
- ✅ 1 Cron job روزانه

## 🎯 نکات مهم

1. **تمدید رایگان فقط یک بار** - بعد از آن باید پرداخت کند
2. **تمدید پولی نیاز به تایید ادمین** - تمدید رایگان خودکار است
3. **فقط آگهی‌های active یا expired** - قابل تمدید هستند
4. **یادآوری 7 روز قبل** - به صورت خودکار ارسال می‌شود
5. **اعلان‌های قدیمی** - بعد از 30 روز پاک می‌شوند

---

## 🌐 لینک‌های مهم

- Frontend: http://localhost:5173
- Backend: http://localhost:8080
- Health Check: http://localhost:8080/health
- پنل ادمین: http://localhost:5173/admin

---

**تاریخ دیپلوی:** 2 دسامبر 2025
**نسخه:** 2.3.0
**وضعیت:** ✅ آماده استفاده

🎉 همه چیز آماده است! سیستم کامل اعلان‌ها، آمار و تمدید فعال شد!
